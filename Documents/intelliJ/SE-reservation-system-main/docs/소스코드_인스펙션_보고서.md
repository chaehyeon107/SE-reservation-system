# 소스코드 인스펙션 보고서

## 프로젝트 정보
- **프로젝트명**: 전북대학교 7호관 무한상상실 예약 시스템
- **담당 기능**: 노트북 열람실 좌석 예약 조회 (SRS 3.1.2.4), 노트북 열람실 좌석 예약 취소 (SRS 3.1.2.3)
- **작성일**: 2025-12-20
- **인스펙션 대상**: Controller, Service, Entity, DTO, Repository, ErrorCode

---

## 1. 인스펙션 대상 파일 목록

| 계층 | 파일명 | 라인 수 | 역할 |
|------|--------|--------|------|
| Controller | `SeatReservationController.java` | 102 | REST API 엔드포인트 |
| Service | `SeatReservationService.java` | 289 | 비즈니스 로직 |
| Entity | `Student.java` | 75 | 학생 엔티티 |
| Entity | `SeatReservation.java` | 58 | 좌석 예약 엔티티 |
| DTO | `SeatReservationResponseDto.java` | 35 | 조회 응답 DTO |
| Repository | `SeatReservationRepository.java` | 61 | 데이터 접근 |
| Enum | `ErrorCode.java` | 70 | 에러 코드 정의 |

---

## 2. Controller 계층 인스펙션

### 2.1 SeatReservationController.java

#### 담당 기능 관련 엔드포인트

```java
// B) 내 좌석 예약 조회
@GetMapping("/reservations")
public ResponseEntity<?> getMySeatReservations(@RequestParam Long studentId)

// E) 좌석 예약 취소
@DeleteMapping("/reservations/{id}")
public ResponseEntity<?> cancelSeatReservation(@PathVariable Long id, @RequestParam Long studentId)
```

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| HTTP 메서드 적절성 | ✅ 적합 | GET(조회), DELETE(취소) RESTful 원칙 준수 |
| URL 설계 | ✅ 적합 | `/api/seats/reservations` 리소스 중심 설계 |
| 파라미터 바인딩 | ✅ 적합 | `@RequestParam`, `@PathVariable` 적절히 사용 |
| 응답 형식 | ✅ 적합 | `ApiResponse.onSuccess()` 통일된 응답 형식 |
| 예외 처리 | ✅ 적합 | Service 계층에 위임 (Controller는 얇게 유지) |

#### 코드 품질 평가

| 항목 | 점수 | 비고 |
|------|------|------|
| 단일 책임 원칙 (SRP) | 5/5 | Controller는 요청 라우팅만 담당 |
| 코드 간결성 | 5/5 | 불필요한 로직 없음 |
| 명명 규칙 | 5/5 | 메서드명이 기능을 명확히 표현 |

---

## 3. Service 계층 인스펙션

### 3.1 SeatReservationService.java

#### 3.1.1 예약 조회 메서드 분석

```java
@Transactional(readOnly = true)
public List<SeatReservationResponseDto> getReservationsByStudentId(Long studentId) {
    // 1. 학번 검증
    validateStudentId(studentId);

    // 2. 해당 학생의 좌석 예약 리스트 조회
    List<SeatReservation> reservations =
            seatReservationRepository.findByStudent_StudentId(studentId);

    // 3. 예약이 없으면 빈 리스트 반환
    if (reservations.isEmpty()) {
        return Collections.emptyList();
    }

    // 4. DTO 변환 후 반환
    return reservations.stream()
            .map(SeatReservationResponseDto::of)
            .toList();
}
```

#### 조회 메서드 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 트랜잭션 설정 | ✅ 적합 | `readOnly = true` 조회 최적화 |
| 입력값 검증 | ✅ 적합 | `validateStudentId()` 호출 |
| Null 처리 | ✅ 적합 | 빈 리스트 시 `Collections.emptyList()` 반환 |
| DTO 변환 | ✅ 적합 | Stream API 활용한 깔끔한 변환 |

---

#### 3.1.2 예약 취소 메서드 분석

```java
@Transactional
public String cancelSeatReservation(Long reservationId, Long studentId) {
    // 1. 학번 검증
    validateStudentId(studentId);

    // 2. 좌석 예약 존재 여부 확인
    SeatReservation reservation = seatReservationRepository.findById(reservationId)
            .orElseThrow(() -> new CustomException(ErrorCode.SEAT_RESERVATION_NOT_FOUND1));

    // 3. 본인 예약인지 확인
    if (!reservation.getStudent().getStudentId().equals(studentId)) {
        throw new CustomException(ErrorCode.NO_CANCEL_PERMISSION1);
    }

    // 4. 현재 시간 기준 비교
    ZoneId kst = ZoneId.of("Asia/Seoul");
    LocalDateTime now = LocalDateTime.now(kst);
    LocalDateTime startAt = LocalDateTime.of(reservation.getDate(), reservation.getStartTime());

    boolean beforeStart = now.isBefore(startAt);

    // 5. 이미 이용 시작한 경우 → 취소 불가
    if (!now.isBefore(startAt)) {
        throw new CustomException(ErrorCode.SEAT_ALREADY_IN_USE);
    }

    // 6. 환급 처리 (하루 사용 시간 복구)
    Student student = reservation.getStudent();
    student.resetSeatIfNeeded(reservation.getDate());

    int durationHours = (int) Duration
            .between(reservation.getStartTime(), reservation.getEndTime())
            .toHours();

    student.applySeatUsageDelta(-durationHours);

    // 7. 예약 삭제
    seatReservationRepository.delete(reservation);

    return beforeStart ? "시간 환급" : "환급 안 됨";
}
```

#### 취소 메서드 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 트랜잭션 설정 | ✅ 적합 | `@Transactional` 쓰기 작업 보장 |
| 입력값 검증 | ✅ 적합 | 학번 검증 우선 수행 |
| 존재 여부 확인 | ✅ 적합 | `findById().orElseThrow()` 패턴 |
| 권한 검증 | ✅ 적합 | 본인 예약만 취소 가능 |
| 시간 검증 | ✅ 적합 | 이미 시작된 예약 취소 방지 |
| 시간대 처리 | ✅ 적합 | `ZoneId.of("Asia/Seoul")` KST 적용 |
| 시간 환급 | ✅ 적합 | `applySeatUsageDelta(-durationHours)` |
| 날짜 리셋 | ✅ 적합 | `resetSeatIfNeeded()` 호출 |

---

#### 3.1.3 학번 검증 메서드 분석

```java
private void validateStudentId(Long studentId) {
    if (studentId == null) {
        throw new CustomException(ErrorCode.INVALID_STUDENT_ID);
    }
    // 하드코딩 무효 학번
    if (studentId == 202099999L || studentId == 202288888L) {
        throw new CustomException(ErrorCode.INVALID_STUDENT_ID);
    }
}
```

#### 학번 검증 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| Null 체크 | ✅ 적합 | null인 경우 예외 발생 |
| 무효 학번 처리 | ⚠️ 개선 가능 | 하드코딩 대신 정규식/DB 검증 고려 |

#### 개선 제안

```java
// 현재 코드 (하드코딩)
if (studentId == 202099999L || studentId == 202288888L) {
    throw new CustomException(ErrorCode.INVALID_STUDENT_ID);
}

// 개선 제안 (정규식 패턴)
private static final Pattern VALID_STUDENT_ID_PATTERN =
    Pattern.compile("^20[12][0-9][0-9]{5}$");

private void validateStudentId(Long studentId) {
    if (studentId == null) {
        throw new CustomException(ErrorCode.INVALID_STUDENT_ID);
    }
    String idStr = String.valueOf(studentId);
    if (!VALID_STUDENT_ID_PATTERN.matcher(idStr).matches()) {
        throw new CustomException(ErrorCode.INVALID_STUDENT_ID);
    }
}
```

> **참고**: 현재 하드코딩 방식은 테스트 목적으로 사용된 것으로 보이며, 실제 운영 환경에서는 학번 검증 로직 개선이 필요합니다.

---

### 3.2 Service 계층 코드 품질 평가

| 항목 | 점수 | 비고 |
|------|------|------|
| 단일 책임 원칙 (SRP) | 4/5 | 좌석 예약 관련 로직 집중, 학번 검증 분리 가능 |
| 개방-폐쇄 원칙 (OCP) | 4/5 | ErrorCode enum으로 확장성 확보 |
| 예외 처리 | 5/5 | CustomException으로 일관된 예외 처리 |
| 트랜잭션 관리 | 5/5 | 읽기/쓰기 트랜잭션 적절히 분리 |
| 코드 가독성 | 5/5 | 주석과 단계별 처리로 가독성 확보 |

---

## 4. Entity 계층 인스펙션

### 4.1 Student.java

#### 담당 기능 관련 메서드

```java
// 날짜별 일일 사용 시간 리셋
public void resetSeatIfNeeded(LocalDate date) {
    if (seatUsageDate == null || !seatUsageDate.equals(date)) {
        seatDailyUsedHours = 0;
        seatUsageDate = date;
    }
}

// 좌석 사용 시간 증감
public void applySeatUsageDelta(int hours) {
    seatDailyUsedHours += hours;
}
```

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 날짜 리셋 로직 | ✅ 적합 | 날짜 변경 시 일일 사용 시간 초기화 |
| 시간 증감 로직 | ⚠️ 주의 | 음수 방지 로직 없음 |

#### 개선 제안

```java
// 현재 코드
public void applySeatUsageDelta(int hours) {
    seatDailyUsedHours += hours;
}

// 개선 제안 (음수 방지)
public void applySeatUsageDelta(int hours) {
    seatDailyUsedHours = Math.max(0, seatDailyUsedHours + hours);
}
```

> **참고**: `applyMeetingUsageDelta()`는 `Math.max(0, ...)` 처리가 있으나 `applySeatUsageDelta()`는 없음. 일관성을 위해 동일한 패턴 적용 권장.

---

### 4.2 SeatReservation.java

#### 구조 분석

```java
@Entity
public class SeatReservation extends BaseEntity {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    private Seat seat;

    @ManyToOne
    private Student student;

    private LocalDate date;
    private LocalTime startTime;
    private LocalTime endTime;

    public static SeatReservation of(Seat seat, Student student,
                                      LocalDate date, LocalTime startTime, int durationHours) {
        // 팩토리 메서드
    }
}
```

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 엔티티 설계 | ✅ 적합 | JPA 연관관계 적절히 설정 |
| 팩토리 메서드 | ✅ 적합 | `of()` 메서드로 생성 캡슐화 |
| 접근 제어 | ✅ 적합 | `AccessLevel.PROTECTED` 생성자 |
| 감사 필드 | ✅ 적합 | `BaseEntity` 상속 (생성/수정 시간) |

---

## 5. DTO 계층 인스펙션

### 5.1 SeatReservationResponseDto.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SeatReservationResponseDto {
    private Long id;
    private int seatId;
    private LocalDate date;
    private LocalTime startTime;
    private LocalTime endTime;
    private Long studentId;

    public static SeatReservationResponseDto of(SeatReservation r) {
        return SeatReservationResponseDto.builder()
                .id(r.getId())
                .seatId(r.getSeat().getId().intValue())
                .date(r.getDate())
                .startTime(r.getStartTime())
                .endTime(r.getEndTime())
                .studentId(r.getStudent().getStudentId())
                .build();
    }
}
```

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 불변성 | ⚠️ 개선 가능 | Setter 없음 (좋음), 하지만 final 필드 아님 |
| 변환 메서드 | ✅ 적합 | `of()` 정적 팩토리 메서드 |
| 타입 변환 | ⚠️ 주의 | `seatId`가 `int`로 형변환 (Long → int) |

#### 개선 제안

```java
// 현재 코드
private int seatId;
.seatId(r.getSeat().getId().intValue())

// 개선 제안 (타입 일관성)
private Long seatId;
.seatId(r.getSeat().getId())
```

---

## 6. Repository 계층 인스펙션

### 6.1 SeatReservationRepository.java

#### 담당 기능 관련 메서드

```java
// 학번으로 예약 조회
List<SeatReservation> findByStudent_StudentId(Long studentId);
```

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| 네이밍 규칙 | ✅ 적합 | Spring Data JPA 명명 규칙 준수 |
| 쿼리 메서드 | ✅ 적합 | 메서드 이름으로 쿼리 자동 생성 |
| N+1 문제 | ⚠️ 점검 필요 | Fetch Join 없음 (성능 이슈 가능) |

#### 개선 제안 (N+1 문제 해결)

```java
// 현재 코드
List<SeatReservation> findByStudent_StudentId(Long studentId);

// 개선 제안 (Fetch Join)
@Query("SELECT sr FROM SeatReservation sr " +
       "JOIN FETCH sr.seat " +
       "JOIN FETCH sr.student " +
       "WHERE sr.student.studentId = :studentId")
List<SeatReservation> findByStudent_StudentIdWithFetch(@Param("studentId") Long studentId);
```

---

## 7. ErrorCode 인스펙션

### 7.1 담당 기능 관련 ErrorCode

| ErrorCode | HTTP Status | 메시지 | 사용 위치 |
|-----------|-------------|--------|----------|
| `INVALID_STUDENT_ID` | 400 Bad Request | 유효하지 않은 학번입니다. | 조회/취소 학번 검증 |
| `SEAT_RESERVATION_NOT_FOUND1` | 404 Not Found | 예약된 내역이 없습니다. | 취소 시 예약 조회 |
| `NO_CANCEL_PERMISSION1` | 403 Forbidden | 권한이 없습니다. | 타인 예약 취소 시도 |
| `SEAT_ALREADY_IN_USE` | 400 Bad Request | 이미 이용이 시작되어 취소할 수 없습니다. | 이미 시작된 예약 취소 |

#### 인스펙션 체크리스트

| 항목 | 상태 | 설명 |
|------|------|------|
| HTTP Status 적절성 | ✅ 적합 | 각 에러 상황에 맞는 상태 코드 |
| 메시지 명확성 | ✅ 적합 | 사용자가 이해하기 쉬운 메시지 |
| 네이밍 규칙 | ⚠️ 개선 가능 | `_1` 접미사 제거 권장 |

---

## 8. 코드 흐름도

### 8.1 예약 조회 흐름

```
[Client] GET /api/seats/reservations?studentId=202111492
    │
    ▼
[Controller] getMySeatReservations(studentId)
    │
    ▼
[Service] getReservationsByStudentId(studentId)
    │
    ├─► validateStudentId(studentId)
    │       └─► [실패] CustomException(INVALID_STUDENT_ID)
    │
    ├─► seatReservationRepository.findByStudent_StudentId(studentId)
    │
    └─► reservations.stream().map(SeatReservationResponseDto::of).toList()
            │
            ▼
        [Response] 200 OK + List<SeatReservationResponseDto>
```

### 8.2 예약 취소 흐름

```
[Client] DELETE /api/seats/reservations/1?studentId=202111492
    │
    ▼
[Controller] cancelSeatReservation(id, studentId)
    │
    ▼
[Service] cancelSeatReservation(reservationId, studentId)
    │
    ├─► validateStudentId(studentId)
    │       └─► [실패] CustomException(INVALID_STUDENT_ID)
    │
    ├─► seatReservationRepository.findById(reservationId)
    │       └─► [실패] CustomException(SEAT_RESERVATION_NOT_FOUND1)
    │
    ├─► 본인 예약 확인
    │       └─► [실패] CustomException(NO_CANCEL_PERMISSION1)
    │
    ├─► 시작 시간 확인 (now < startAt)
    │       └─► [실패] CustomException(SEAT_ALREADY_IN_USE)
    │
    ├─► student.resetSeatIfNeeded(date)
    │
    ├─► student.applySeatUsageDelta(-durationHours)
    │
    └─► seatReservationRepository.delete(reservation)
            │
            ▼
        [Response] 200 OK + "시간 환급"
```

---

## 9. 인스펙션 결과 요약

### 9.1 전체 평가

| 계층 | 평가 | 점수 |
|------|------|------|
| Controller | 우수 | 5/5 |
| Service | 우수 | 4.5/5 |
| Entity | 양호 | 4/5 |
| DTO | 양호 | 4/5 |
| Repository | 양호 | 4/5 |
| ErrorCode | 양호 | 4/5 |
| **종합** | **양호** | **4.25/5** |

### 9.2 강점

1. **일관된 코드 스타일**: Lombok 활용, 팩토리 메서드 패턴
2. **적절한 예외 처리**: CustomException + ErrorCode enum
3. **트랜잭션 관리**: 읽기/쓰기 분리
4. **RESTful API 설계**: HTTP 메서드와 상태 코드 적절히 사용
5. **시간대 처리**: KST(Asia/Seoul) 명시적 적용

### 9.3 개선 권장 사항

| 우선순위 | 항목 | 현재 상태 | 개선 방향 |
|----------|------|----------|----------|
| 낮음 | 학번 검증 | 하드코딩 | 정규식/DB 검증 |
| 낮음 | applySeatUsageDelta | 음수 가능 | Math.max(0, ...) 적용 |
| 낮음 | seatId 타입 | int (형변환) | Long 통일 |
| 중간 | N+1 문제 | Fetch Join 없음 | JOIN FETCH 추가 |
| 낮음 | ErrorCode 네이밍 | `_1` 접미사 | 명확한 네이밍 |

---

## 10. 결론

노트북 열람실 좌석 예약 조회 및 취소 기능의 소스코드는 전반적으로 **양호한 품질**을 보여줍니다.

- **Controller**: 얇은 계층 유지, REST 원칙 준수
- **Service**: 비즈니스 로직 집중, 적절한 예외 처리
- **Entity/DTO**: JPA 설계 원칙 준수, 팩토리 메서드 활용

일부 개선 권장 사항이 있으나, 현재 상태에서도 기능 요구사항(SRS 3.1.2.3, 3.1.2.4)을 충족하며 안정적으로 동작합니다.
